stages:
  - test          
  - build
  - package

variables:
  APP_VERSION: $CI_PIPELINE_IID

test:
  stage: test
  script:
    - chmod +x ./setup_env.sh
    - ./setup_env.sh
    - cat config.js

build-job:
  stage: build
  image: node:latest
  script:
    - echo "BUILDING"
    - npm install
    - echo "Build complete."

package-docker:
  stage: package
  image: docker:20.10.20
  services:
    - docker:20.10.20-dind
  script:
    - echo $CI_REGISTRY_PASSWORD | docker login $CI_REGISTRY -u $CI_REGISTRY_USER $CI_REGISTRY --password-stdin
    - docker build . -t $CI_REGISTRY_IMAGE
    - docker image ls
    - docker push --all-tags $CI_REGISTRY_IMAGE

